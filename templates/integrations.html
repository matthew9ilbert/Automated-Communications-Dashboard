
{% extends "base.html" %}

{% block title %}Integrations - EVS Manager{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-plug me-2"></i>Integrations</h1>
        <button class="btn btn-primary" onclick="checkAllIntegrations()">
            <i class="fas fa-sync me-1"></i>Check Status
        </button>
    </div>

    <!-- Apple Integrations -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fab fa-apple me-2"></i>Apple Integrations</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Apple Shortcuts</h6>
                            <p class="text-muted">Create shortcuts to interact with your EVS system</p>
                            <div id="apple-shortcuts-status" class="mb-3">
                                <span class="badge bg-warning">Checking...</span>
                            </div>
                            <button class="btn btn-outline-primary btn-sm" onclick="showShortcutInstructions()">
                                Setup Instructions
                            </button>
                        </div>
                        <div class="col-md-6">
                            <h6>iMessage Integration</h6>
                            <p class="text-muted">Process messages via Shortcuts</p>
                            <div id="imessage-status" class="mb-3">
                                <span class="badge bg-secondary">Via Shortcuts</span>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6>Voicemail Transcripts</h6>
                            <p class="text-muted">Process voicemail transcripts automatically</p>
                            <div id="voicemail-status" class="mb-3">
                                <span class="badge bg-secondary">Via Shortcuts</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Apple Calendar/Mail</h6>
                            <p class="text-muted">Sync with Apple Calendar and Mail</p>
                            <div id="apple-calendar-status" class="mb-3">
                                <span class="badge bg-warning">Needs Setup</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Microsoft Integrations -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fab fa-microsoft me-2"></i>Microsoft Integrations</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6>Microsoft Teams</h6>
                            <p class="text-muted">Receive Teams messages and notifications</p>
                            <div id="teams-status" class="mb-3">
                                <span class="badge bg-warning">Checking...</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h6>Outlook</h6>
                            <p class="text-muted">Email integration and calendar sync</p>
                            <div id="outlook-status" class="mb-3">
                                <span class="badge bg-warning">Checking...</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h6>Office 365</h6>
                            <p class="text-muted">Excel, Word, PowerPoint integration</p>
                            <div id="office365-status" class="mb-3">
                                <span class="badge bg-warning">Checking...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Google Integrations -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fab fa-google me-2"></i>Google Integrations</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6>Gmail</h6>
                            <p class="text-muted">Email processing and notifications</p>
                            <div id="gmail-status" class="mb-3">
                                <span class="badge bg-warning">Checking...</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h6>Google Calendar</h6>
                            <p class="text-muted">Calendar synchronization</p>
                            <div id="gcalendar-status" class="mb-3">
                                <span class="badge bg-warning">Checking...</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h6>Google Workspace</h6>
                            <p class="text-muted">Sheets, Docs, Drive integration</p>
                            <div id="gworkspace-status" class="mb-3">
                                <span class="badge bg-warning">Checking...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Integration Logs -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-history me-2"></i>Recent Integration Activity</h5>
                </div>
                <div class="card-body">
                    <div id="integration-logs">
                        <p class="text-muted">Loading recent activity...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Apple Shortcuts Instructions Modal -->
<div class="modal fade" id="shortcutInstructionsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Apple Shortcuts Setup Instructions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="shortcut-instructions-content">
                    <p>Loading instructions...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function checkAllIntegrations() {
    fetch('/api/integrations/status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateIntegrationStatus(data.integrations);
            }
        })
        .catch(error => {
            console.error('Error checking integrations:', error);
        });
}

function updateIntegrationStatus(integrations) {
    // Update Apple Shortcuts status
    const shortcutsElement = document.getElementById('apple-shortcuts-status');
    if (integrations.apple_shortcuts.configured) {
        shortcutsElement.innerHTML = '<span class="badge bg-success">Configured</span>';
    } else {
        shortcutsElement.innerHTML = '<span class="badge bg-danger">Not Configured</span>';
    }
    
    // Update Microsoft status
    const teamsElement = document.getElementById('teams-status');
    const outlookElement = document.getElementById('outlook-status');
    const office365Element = document.getElementById('office365-status');
    
    if (integrations.microsoft_graph.configured) {
        teamsElement.innerHTML = '<span class="badge bg-success">Configured</span>';
        outlookElement.innerHTML = '<span class="badge bg-success">Configured</span>';
        office365Element.innerHTML = '<span class="badge bg-success">Configured</span>';
    } else {
        teamsElement.innerHTML = '<span class="badge bg-danger">Not Configured</span>';
        outlookElement.innerHTML = '<span class="badge bg-danger">Not Configured</span>';
        office365Element.innerHTML = '<span class="badge bg-danger">Not Configured</span>';
    }
    
    // Update Google status
    const gmailElement = document.getElementById('gmail-status');
    const gcalendarElement = document.getElementById('gcalendar-status');
    const gworkspaceElement = document.getElementById('gworkspace-status');
    
    if (integrations.google_services.configured) {
        gmailElement.innerHTML = '<span class="badge bg-success">Configured</span>';
        gcalendarElement.innerHTML = '<span class="badge bg-success">Configured</span>';
        gworkspaceElement.innerHTML = '<span class="badge bg-success">Configured</span>';
    } else {
        gmailElement.innerHTML = '<span class="badge bg-danger">Not Configured</span>';
        gcalendarElement.innerHTML = '<span class="badge bg-danger">Not Configured</span>';
        gworkspaceElement.innerHTML = '<span class="badge bg-danger">Not Configured</span>';
    }
}

function showShortcutInstructions() {
    fetch('/api/integrations/status')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.integrations.apple_shortcuts.webhook_urls) {
                const urls = data.integrations.apple_shortcuts.webhook_urls;
                const instructions = `
                    <h6>Setting up Apple Shortcuts</h6>
                    <p>Follow these steps to integrate with Apple Shortcuts:</p>
                    <ol>
                        <li>Open the Shortcuts app on your iPhone/iPad</li>
                        <li>Create a new shortcut</li>
                        <li>Add "Get Contents of URL" action</li>
                        <li>Use these URLs for different actions:</li>
                    </ol>
                    
                    <h6>Available Endpoints:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Action</th>
                                    <th>URL</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Log Message</td>
                                    <td><code>${urls.log_message}</code></td>
                                </tr>
                                <tr>
                                    <td>Create Task</td>
                                    <td><code>${urls.create_task}</code></td>
                                </tr>
                                <tr>
                                    <td>Voice Memo</td>
                                    <td><code>${urls.voice_memo}</code></td>
                                </tr>
                                <tr>
                                    <td>Calendar Event</td>
                                    <td><code>${urls.calendar_event}</code></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>Note:</strong> Set the HTTP method to POST and Content-Type to application/json for all requests.
                    </div>
                `;
                
                document.getElementById('shortcut-instructions-content').innerHTML = instructions;
                new bootstrap.Modal(document.getElementById('shortcutInstructionsModal')).show();
            }
        });
}

// Check integrations on page load
document.addEventListener('DOMContentLoaded', function() {
    checkAllIntegrations();
});
</script>
{% endblock %}
